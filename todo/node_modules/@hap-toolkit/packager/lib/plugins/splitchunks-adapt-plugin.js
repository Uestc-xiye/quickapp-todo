"use strict";var _path=_interopRequireDefault(require("path")),_webpackSources=require("webpack-sources"),_info=require("../common/info"),_compilationConfig=require("@hap-toolkit/shared-utils/compilation-config"),_utils=require("../common/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const SEP=_path.default.sep,SPLIT_CHUNKS_PAGE_NAME=_compilationConfig.compileOptionsMeta.splitChunksNameEnum.PAGE,SPLIT_CHUNKS_APP_NAME=_compilationConfig.compileOptionsMeta.splitChunksNameEnum.APP,MAIN_PKG_NAME=_compilationConfig.compileOptionsMeta.MAIN_PKG_NAME,pluginName="splitChunksAdaptPlugin",actualModuleRequireParam=["module.exports","module","module.exports","__webpack_require__"],moduleRequireNativeFunctions=["$app_define$","$app_bootstrap$","$app_require$","$app_define_wrap$"],appModuleRequireNativeFunctions=["$app_define$","$app_bootstrap$","$app_require$"],actualParamStr=actualModuleRequireParam.concat(moduleRequireNativeFunctions).join(", "),formalParamStr=moduleRequireNativeFunctions.join(", "),quickappGlobal="var __quickappGlobal = Object.getPrototypeOf(global) || global;";function replaceWindowWithGlobalStr(e,a){let o=e?"global":"__quickappGlobal";return a.replace(/window(?=\["webpackJsonp"\])/g,o)}function createChunksJsonInfo(e){let a={[SPLIT_CHUNKS_APP_NAME]:{jsonFilePath:SPLIT_CHUNKS_APP_NAME,chunks:{}},[SPLIT_CHUNKS_PAGE_NAME]:{jsonFilePath:SPLIT_CHUNKS_PAGE_NAME,chunks:{}}};return e&&(a[MAIN_PKG_NAME]={resource:MAIN_PKG_NAME,jsonFilePath:MAIN_PKG_NAME+SEP+SPLIT_CHUNKS_PAGE_NAME,chunks:{}},a=e.reduce((e,a)=>(e[a.resource]={resource:a.resource,jsonFilePath:a.resource+SEP+SPLIT_CHUNKS_PAGE_NAME,standalone:a.standalone,chunks:{}},e),a)),a}class SplitChunksAdaptPlugin{constructor(e){this.options=e}apply(e){e.hooks.compilation.tap(pluginName,a=>{const o=this.options;let t;!o.disableSubpackages&&o.subpackages&&o.subpackages.length>0&&(t=o.subpackages);const s=new Set;let n=[],i="";a.hooks.optimizeChunkIds.tap(pluginName,a=>{n=(0,_info.getEntryFiles)(e.options.entry);const o=a.filter(e=>-1===n.indexOf(`${e.name}.js`)).map(e=>`"${e.id}": "${e.name}.js"`);i=`__quickappGlobal.chunkFileMap = __quickappGlobal.chunkFileMap || {${o.join(", ")}};`,a.forEach(e=>{e.name.match(/\bapp$/)&&e.entryModule&&(e.groupsIterable.forEach(e=>{e.chunks.forEach(e=>{s.add(`${e.name}.js`)})}),s.delete("app.js"))})}),a.hooks.optimizeChunkAssets.tapAsync(pluginName,(e,o)=>{e.forEach(e=>{e.files.forEach(o=>{if(!o.match(/\.js$/))return;let t=actualParamStr,s=formalParamStr,n=!1;o.match(/\bapp\.js$/)&&(t=actualModuleRequireParam.concat(appModuleRequireNativeFunctions).join(", "),s=appModuleRequireNativeFunctions.join(", "));let u=a.assets[o].source();e.entryModule?u=u.replace(/\/\/\s+webpackBootstrap/,e=>`${e}\n\n\t\t\t\t\t${quickappGlobal}\n\t\t\t\t\t${i}\n`):n=!0,u=replaceWindowWithGlobalStr(n,u),u=u.replace(/(?<=(if\(installedChunks\[depId\]\s+!==\s+0\)\s+))fulfilled\s+=\s+false;/,"{ fulfilled = false; $app_evaluate$(`${__quickappGlobal.chunkFileMap[depId]}`); }"),u=u.replace(/(?<=(modules\[moduleId\].call\())module.exports,\s+module,\s+module.exports,\s+__webpack_require__/g,t),u=u.replace(/(?<=function\()module,\s+(exports|__webpack_exports__)(,\s+__webpack_require__)?/g,e=>`${e}, ${s}`),a.assets[o]=new _webpackSources.ConcatSource(u)})}),o()}),a.hooks.afterOptimizeChunkAssets.tap(pluginName,e=>{const o=createChunksJsonInfo(t);e.forEach(e=>{e.files.forEach(i=>{if(i.match(/\.js$/)&&-1===n.indexOf(i)){const n=a.assets[i].source();s.has(i)?o[SPLIT_CHUNKS_APP_NAME].chunks[i]=n:(o[SPLIT_CHUNKS_PAGE_NAME].chunks[i]=n,t&&a.chunkGroups.forEach(e=>{if(-1!==e.chunks.map(e=>e.name+".js").indexOf(i)){const a=e.options.name,{resource:t,standalone:s}=(e=>{const a=Object.keys(o).find(a=>e.startsWith(a+SEP));return a?o[a]:o[MAIN_PKG_NAME]})(a);s?o[t].chunks=o[SPLIT_CHUNKS_PAGE_NAME].chunks:o[t].chunks[i]=n}})),delete a.assets[i],e.files=[]}})});for(const e in o){const t=o[e].chunks;if(!(0,_utils.isEmptyObject)(t)){const s=o[e].jsonFilePath;a.assets[s]=new _webpackSources.ConcatSource(JSON.stringify(t))}}})})}}module.exports=SplitChunksAdaptPlugin;
//# sourceMappingURL=splitchunks-adapt-plugin.js.map
