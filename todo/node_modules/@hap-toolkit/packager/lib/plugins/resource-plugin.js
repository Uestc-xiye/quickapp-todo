"use strict";var _path=_interopRequireDefault(require("path")),_fsExtra=_interopRequireDefault(require("fs-extra")),_aaptjs=_interopRequireDefault(require("@hap-toolkit/aaptjs")),_glob=_interopRequireDefault(require("glob")),_eventBus=_interopRequireDefault(require("@hap-toolkit/shared-utils/event-bus")),_sharedUtils=require("@hap-toolkit/shared-utils"),_info=require("../common/info"),_shared=require("../common/shared");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const I18N_DIRECTORY="i18n",{PACKAGER_BUILD_DONE:PACKAGER_BUILD_DONE}=_eventBus.default,FILE_EXT_LIST=_info.name.extList,FILE_EXT_NORES=FILE_EXT_LIST.concat([".js",".jsx",".coffee",".ts",".tsx",".vue",".css",".less",".sass",".styl",".html",".json",".md"]),EXT_PATTERN=FILE_EXT_NORES.map(e=>"*"+e).join("|");function getFiles(e,t){return _glob.default.sync(e,{nodir:!0,cwd:t,ignore:["**/Thumbs.db"],absolute:!0})}function geti18nFiles(e){const t=_path.default.join(e,I18N_DIRECTORY);let s=[];return _fsExtra.default.existsSync(t)&&(s=getFiles("**/*.json",t)),s}function minifyJson(e,t){try{const s=_fsExtra.default.readFileSync(e,"utf8"),o=JSON.parse(s),i=JSON.stringify(o);_fsExtra.default.writeFileSync(t,i)}catch(t){_sharedUtils.colorconsole.error(`### App Loader ### ${(0,_sharedUtils.relateCwd)(e)} 文件 压缩拷贝失败`,t.message)}}function minifyi18nFiles(e){const t=_path.default.join(e,I18N_DIRECTORY);if(_fsExtra.default.existsSync(t)){getFiles("**/*.json",t).forEach(e=>{minifyJson(e,e)})}}function minifySitemap(e,t){const s=_path.default.join(e,"sitemap.json");_fsExtra.default.existsSync(s)&&minifyJson(s,s)}function ResourcePlugin(e){this.options=e}ResourcePlugin.prototype.apply=function(e){const t=this.options,s=e.options;e.hooks.watchRun.tapAsync("ResourcePlugin",(function(e,t){Object.keys(s.entry).forEach((function(e){const t=s.entry[e];t instanceof Array&&!/app\.js/.test(e)&&-1!==t[0].indexOf("webpack-dev-server")&&t.shift()})),t()})),e.hooks.emit.tapAsync("ResourcePlugin",(function(e,s){const o=t.src,i=t.dest;let n,a=getFiles(`**/+(!(${EXT_PATTERN})|manifest.json|sitemap.json)`,o);a=a.concat(geti18nFiles(o));try{const e=_path.default.join(o,"manifest.json"),t=(0,_sharedUtils.readJson)(e);n=t.icon,n=_path.default.join(o,n)}catch(e){n=""}let r=a.map(e=>({srcFile:e,destFile:_path.default.resolve(i,_path.default.relative(o,e))}));const{projectRoot:l}=t,u=_path.default.join(l,"node_modules"),f=e.fileDependencies;for(let e of f){const t=_path.default.extname(e);e.indexOf(u)>-1&&-1===FILE_EXT_NORES.indexOf(t)&&-1===a.indexOf(e)&&t&&r.push({srcFile:e,destFile:_path.default.resolve(i,_path.default.relative(l,e))})}r=r.filter(e=>{const{srcFile:s}=e;return!t.optimizeUnusedResource||(f.has(s)||s===n||"manifest.json"===_path.default.relative(o,s))});const c=r.map(e=>new Promise((t,s)=>{const{srcFile:o,destFile:i}=e;_fsExtra.default.mkdirp(_path.default.dirname(i),()=>{let e;e=/.+\.9\.png$/.test(o)?_aaptjs.default.singleCrunch(o,i).catch(e=>{e&&_sharedUtils.colorconsole.log(`复制文件 ${(0,_sharedUtils.relateCwd)(o)} 失败：${e.message}`)}):_fsExtra.default.copy(o,i).catch(e=>{throw _sharedUtils.colorconsole.log(`复制 ${o} -> ${i} 失败`),e}),e.then(t,s)})}));Promise.all(c).then(()=>{_eventBus.default.emit(PACKAGER_BUILD_DONE),s()},e=>{throw _sharedUtils.colorconsole.log("ERROR: 拷贝文件出现错误",e),e})})),e.hooks.emit.tapAsync("ResourcePlugin",(e,s)=>{const o=t.src,i=t.dest,n=_path.default.join(o,"manifest.json"),a=_path.default.join(i,"manifest.json"),r=_fsExtra.default.existsSync(n);if(minifyi18nFiles(i),minifySitemap(i),r){let o;try{o=(0,_sharedUtils.readJson)(n)}catch(t){return e.errors.push(t),void s()}const{configDebugInManifest:i}=t;-1===[!0,!1].indexOf(i)&&(_sharedUtils.colorconsole.error(`### App Loader ### 参数configDebugInManifest必须为布尔值：${i}`),s()),o=(0,_shared.updateManifest)(o,i);const r=JSON.stringify(o,null,i?2:0);_fsExtra.default.writeFile(a,r,"utf8",e=>{e&&_sharedUtils.colorconsole.error("### App Loader ### 更新 %s 失败：%s",(0,_sharedUtils.relateCwd)(n),e.message),s()})}else _sharedUtils.colorconsole.error("### App Loader ### %s 下无 manifest.json 文件",(0,_sharedUtils.relateCwd)(o)),s()})},module.exports=ResourcePlugin;
//# sourceMappingURL=resource-plugin.js.map
