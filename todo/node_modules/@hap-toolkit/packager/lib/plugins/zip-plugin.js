"use strict";var _fsExtra=_interopRequireDefault(require("fs-extra")),_path=_interopRequireDefault(require("path")),_sharedUtils=require("@hap-toolkit/shared-utils"),_config=_interopRequireDefault(require("@hap-toolkit/shared-utils/config")),_utils=require("../common/utils"),_compilationConfig=require("@hap-toolkit/shared-utils/compilation-config"),_constant=require("../common/constant"),_index=require("../process/index"),_signature=require("../signature");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function resolveFiles(e,i){let t=(0,_utils.lsdirdeep)(e);return t.includes(_constant.DIGEST_ZIP_PATH)?(console.warning(`检测到存在快应用保留文件: ${_constant.DIGEST_ZIP_PATH}`),!1):(t=(0,_utils.sortFilesBy)(t,i),t)}function getProjectSignConfig(e){const i=e.cwd||_config.default.projectPath,t=e.pathSignFolder||"sign",a={debug:{privatekey:_path.default.join(i,t,"debug/private.pem"),certificate:_path.default.join(i,t,"debug/certificate.pem")},builtinDebug:{privatekey:_path.default.join(_signature.builtinSignFolder,"private.pem"),certificate:_path.default.join(_signature.builtinSignFolder,"certificate.pem")},release:{privatekey:_path.default.join(i,t,"private.pem"),certificate:_path.default.join(i,t,"certificate.pem")},OldRelease:{privatekey:_path.default.join(i,t,"release/private.pem"),certificate:_path.default.join(i,t,"release/certificate.pem")}};let o;switch(e.signMode){case _compilationConfig.compileOptionsMeta.signModeEnum.NULL:_sharedUtils.colorconsole.log("### App Loader ### 项目构建禁用了签名功能"),o=!1;break;case _compilationConfig.compileOptionsMeta.signModeEnum.BUILD:{let{privatekey:e,certificate:i}=a.debug;_fsExtra.default.existsSync(e)&&_fsExtra.default.existsSync(i)?_sharedUtils.colorconsole.log("### App Loader ### 项目构建启用了用户 debug 签名"):(e=a.builtinDebug.privatekey,i=a.builtinDebug.certificate,_sharedUtils.colorconsole.log("### App Loader ### 项目构建启用了内置 debug 签名")),o={privatekey:_fsExtra.default.readFileSync(e),certificate:_fsExtra.default.readFileSync(i)};break}case _compilationConfig.compileOptionsMeta.signModeEnum.RELEASE:{_sharedUtils.colorconsole.log("### App Loader ### 项目构建启用了 release 签名");let{privatekey:e,certificate:i}=a.release;if(!_fsExtra.default.existsSync(e)){if(e=a.OldRelease.privatekey,!_fsExtra.default.existsSync(e))throw new Error(`### App Loader ### 编译错误，缺少release签名私钥文件：${e}`);_sharedUtils.colorconsole.warn('### App Loader ### 后续将使用新release私钥文件地址 "sign/privatekey"，请注意更新')}if(!_fsExtra.default.existsSync(i)){if(i=a.OldRelease.certificate,!_fsExtra.default.existsSync(e))throw new Error(`### App Loader ### 编译错误，缺少release签名证书文件：${i}`);_sharedUtils.colorconsole.warn('### App Loader ### 后续将使用新release证书文件地址 "sign/certificate"，请注意更新')}o={privatekey:_fsExtra.default.readFileSync(e),certificate:_fsExtra.default.readFileSync(i)};break}default:throw new Error(`### App Loader ### 编译错误，请联系官方开发人员：signMode出错：${e.signMode}`)}return o}function getDistFilename(e,i){let t;switch(e.signMode===_compilationConfig.compileOptionsMeta.signModeEnum.NULL&&_sharedUtils.colorconsole.log("### App Loader ### 项目构建禁用了签名能力"),e.signMode){case _compilationConfig.compileOptionsMeta.signModeEnum.NULL:t="nosign";break;case _compilationConfig.compileOptionsMeta.signModeEnum.BUILD:t="debug";break;case _compilationConfig.compileOptionsMeta.signModeEnum.RELEASE:t="release";break;default:throw new Error(`### App Loader ### 编译错误，请联系官方开发人员：signMode出错：${e.signMode}`)}return`${e.name}.${t}.${i}`}function generateDistFile(e,i,t,a){const o=getDistFilename(i,a),s=_path.default.join(i.output,o);_fsExtra.default.writeFileSync(s,e),_sharedUtils.colorconsole.log(`### App Loader ### 项目构建并生成文件：${o}`)}function ZipPlugin(e){this.options=Object.assign({priorities:["manifest.json","app.js"]},e),this.manifestFile=_path.default.resolve(this.options.pathSrc,"manifest.json")}ZipPlugin.prototype.apply=function(e){const i=this.options;let t;!i.disableSubpackages&&i.subpackages&&i.subpackages.length>0&&(t=i.subpackages),e.hooks.done.tapAsync("ZipPlugin",async(a,o)=>{try{this.signConfig=getProjectSignConfig(i)}catch(e){return a.compilation.errors.push(e),void o()}if(_compilationConfig.compileOptionsObject.splitChunksMode===_compilationConfig.compileOptionsMeta.splitChunksModeEnum.SMART){const e=i.priorities.findIndex(e=>"app.js"===e);i.priorities.splice(e,0,_compilationConfig.compileOptionsMeta.splitChunksNameEnum.APP),i.priorities.splice(e+2,0,_compilationConfig.compileOptionsMeta.splitChunksNameEnum.PAGE)}let s=resolveFiles(i.pathBuild,i.priorities);if("release"===i.sign&&(s=s.filter(e=>!/\.map$/.test(e))),!1===s)return void o();const{fullPackage:n,subPackages:r}=(0,_index.createPackagesDefinition)(i.name,t,i.icon,i.comment);(0,_index.allocateResourceToPackages)(s,i.pathBuild,n,r);const{rpksBuffer:l,rpkBuffer:c}=await(0,_index.buildProjectAndOutput)(n,r,this.signConfig,i.disableStreamPack);_fsExtra.default.ensureDirSync(i.output),generateDistFile(c,i,e.watchMode,"rpk"),l&&generateDistFile(l,i,e.watchMode,"rpks"),o()}),e.hooks.watchRun.tapAsync("watch",(e,i)=>{if(e.watchFileSystem.watcher.mtimes[this.manifestFile])try{const e=(0,_sharedUtils.readJson)(this.manifestFile),i=(0,_utils.genPriorities)(e);this.options.priorities=i}catch(e){}i()})},module.exports=ZipPlugin;
//# sourceMappingURL=zip-plugin.js.map
