"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.processImportFrag=processImportFrag,exports.processTemplateFrag=processTemplateFrag,exports.processStyleFrag=processStyleFrag,exports.processScriptFrag=processScriptFrag,exports.parseImportList=parseImportList;var _path=_interopRequireDefault(require("path")),_config=_interopRequireDefault(require("@hap-toolkit/shared-utils/config")),_compilationConfig=require("@hap-toolkit/shared-utils/compilation-config"),_validator=_interopRequireDefault(require("@hap-toolkit/compiler/lib/template/validator")),_utils=require("./common/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const cwd=_config.default.projectPath,defaultLoaders={component:require.resolve("./ux-loader.js"),fragment:require.resolve("./fragment-loader.js"),template:require.resolve("./template-loader.js"),style:require.resolve("./style-loader.js"),script:require.resolve("./script-loader.js"),module:require.resolve("./module-loader.js"),babel:require.resolve("babel-loader"),mainfest:require.resolve("./manifest-loader.js"),access:require.resolve("./access-loader.js"),"extract-css":require.resolve("./extract-css-loader.js")},optionBabelrc=process&&process.babelrc;function makeLoaderString(e,r,t){let s;return r=r||{},e===_utils.FRAG_TYPE.IMPORT?(s=[{name:defaultLoaders.component,query:{cwd:cwd,type:_utils.FRAG_TYPE.IMPORT}}],(0,_utils.stringifyLoaders)(s)):e===_utils.FRAG_TYPE.TEMPLATE?(s=[{name:defaultLoaders.template}],r.alone||s.push({name:defaultLoaders.fragment,query:{index:0,type:_utils.FRAG_TYPE.TEMPLATE}}),(0,_utils.stringifyLoaders)(s)):e===_utils.FRAG_TYPE.STYLE?(s=[{name:defaultLoaders.style,query:{index:0,type:_utils.FRAG_TYPE.STYLE}}],_compilationConfig.compileOptionsObject.enableExtractCss&&s.unshift({name:defaultLoaders["extract-css"]}),r.lang&&"css"!==r.lang&&s.push({name:`${r.lang}-loader`}),r.alone||s.push({name:defaultLoaders.fragment,query:{index:0,type:_utils.FRAG_TYPE.STYLE}}),(0,_utils.stringifyLoaders)(s)):e===_utils.FRAG_TYPE.SCRIPT?(s=[],_compilationConfig.compileOptionsObject.enableIstanbul&&s.push({name:"istanbul-instrumenter-loader",query:{}}),s.push({name:defaultLoaders.script},{name:defaultLoaders.module}),t===_utils.ENTRY_TYPE.APP?(s.push({name:defaultLoaders.mainfest,query:{path:_path.default.dirname(r.path)}},{name:require.resolve("babel-loader"),query:{cwd:cwd,cacheDirectory:!0,comments:!1,babelrc:optionBabelrc}}),_compilationConfig.compileOptionsObject.enableDiagnosis&&s.push({name:require.resolve("@hap-toolkit/packager/lib/loaders/diagnosis-loader.js"),query:{pureScript:!0,hookName:"onCreate",hostName:_compilationConfig.compileOptionsObject.enableDiagnosis}})):(s.push({name:require.resolve("babel-loader"),query:{cwd:cwd,cacheDirectory:!0,plugins:[require.resolve("./babel-plugin-jsx.js")],comments:!1,babelrc:optionBabelrc}}),(0,_utils.isUXRender)(t)&&s.push({name:defaultLoaders.access})),r.alone||s.push({name:defaultLoaders.fragment,query:{index:0,type:_utils.FRAG_TYPE.SCRIPT}}),_compilationConfig.compileOptionsObject.enableE2e&&s.push({name:require.resolve("@hap-toolkit/packager/lib/loaders/inject-suite-loader.js"),query:{hookName:"onCreate"}}),(0,_utils.stringifyLoaders)(s)):void 0}function processImportFrag(e,r,t){let s="";if(r.length)for(let a=0;a<r.length;a++){const o=r[a];let i=o.attrs.src,l=o.attrs.name;if(!i)return e.emitWarning(new Error("导入组件需要设置属性 `src` ")),"";if(!o.isValid)return e.emitError(new Error(`导入组件resolve 出错 ${o.err}`)),"";i=o.srcPath,l||(l=(0,_utils.getNameByPath)(i)),l=l.toLowerCase(),_validator.default.isReservedTag(l)&&e.emitWarning(new Error("导入组件的属性 `name` 不能使用保留字: "+l)),t.push(l),(0,_utils.print)({name:l,src:i});let n=(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.IMPORT),`${i}?uxType=${_utils.ENTRY_TYPE.COMP}&name=${l}`);_compilationConfig.compileOptionsObject.stats&&(n=`console.time(\`PERF: require @app-component/${l}\`)\n${n}`,n+=`console.timeEnd(\`PERF: require @app-component/${l}\`)\n\n`),s+=n}return s}function processTemplateFrag(e,r,t,s){let a="{}";if(r.length){const o=r[0];let i=e.resourcePath;const l=o.attrs.src;l&&(i=l),s=s.map(e=>"importNames[]="+e),a=(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.TEMPLATE,{alone:!!l}),`${i}?uxType=${t}&${s.join(",")}`)}else e.emitError(new Error("需要模板片段"));return a}function processStyleFrag(e,r,t){let s="{}";if(r.length){const a=r[0];let o=e.resourcePath;const i=a.attrs.src,l=a.attrs.lang;i&&(o=i),(0,_utils.print)({style:o}),s=(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.STYLE,{alone:!!i,lang:l}),`${o}?uxType=${t}`)}return s}function processScriptFrag(e,r,t){let s="null";if(r.length){const a=r[0];let o=e.resourcePath;const i=a.attrs.src;i&&(o=i),s=(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.SCRIPT,{alone:!!i,path:e.resourcePath},t),`${o}?uxType=${t}`)}return s}function parseImportList(e,r){return Promise.all(r.map(r=>resolveImportItemSrc(e,r)))}function resolveImportItemSrc(e,r){return r.attrs.src?new Promise(t=>{e.resolve(e.context,r.attrs.src,(function(e,s){return e?(r.isValid=!1,r.err=e,t(r)):(r.isValid=!0,r.srcPath=s,t(r))}))}):(r.isValid=!1,Promise.resolve(r))}
//# sourceMappingURL=ux-fragment-utils.js.map
