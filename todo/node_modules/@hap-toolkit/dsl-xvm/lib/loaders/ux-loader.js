"use strict";var _path=_interopRequireDefault(require("path")),_loaderUtils=_interopRequireDefault(require("loader-utils")),_compiler=require("@hap-toolkit/compiler"),_validator=_interopRequireDefault(require("@hap-toolkit/compiler/lib/template/validator")),_compilationConfig=require("@hap-toolkit/shared-utils/compilation-config"),_uxFragmentUtils=require("./ux-fragment-utils"),_utils=require("./common/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function assemble(e,o,p,t){const r=[],{enablePerformanceCheck:n}=_compilationConfig.compileOptionsObject,s=[];return n&&r.push(`console.record('### App Performance ### 执行自定义组件模块[PERF:RPK:defineCustomCompModule(${p})]开始：' + new Date().toJSON())\n    console.time('PERF:RPK:defineCustomCompModule(${p})')\n    console.time('PERF:RPK:defineCustomCompImport(${p})')`),r.push((0,_uxFragmentUtils.processImportFrag)(e,o.import,s)),n&&r.push(`console.timeEnd('PERF:RPK:defineCustomCompImport(${p})')`),r.push(`var $app_style$ = ${(0,_uxFragmentUtils.processStyleFrag)(e,o.style,t)}`),n&&r.push(`console.time('PERF:RPK:defineCustomCompScript(${p})')`),r.push(`var $app_script$ = ${(0,_uxFragmentUtils.processScriptFrag)(e,o.script,t)}`),n&&r.push(`console.timeEnd('PERF:RPK:defineCustomCompScript(${p})')\n    onsole.record('### App Performance ### 定义自定义组件函数[PERF:RPK:appDefineCustomCompFn(${p})]开始：' + new Date().toJSON())\n    console.time('PERF:RPK:appDefineCustomCompFn(${p})')`),r.push(`$app_define$('@app-component/${p}', [], function($app_require$, $app_exports$, $app_module$) {`),o.script.length>0&&r.push("     $app_script$($app_module$, $app_exports$, $app_require$)\n         if ($app_exports$.__esModule && $app_exports$.default) {\n            $app_module$.exports = $app_exports$.default\n        }"),r.push(`     $app_module$.exports.template = ${(0,_uxFragmentUtils.processTemplateFrag)(e,o.template,t,s)}`),o.style.length>0&&r.push("     $app_module$.exports.style = $app_style$"),r.push("})"),n&&r.push(`\n    console.record('### App Performance ### 定义自定义组件函数[PERF:RPK:appDefineCustomCompFn(${p})]结束：' + new Date().toJSON())\n    console.timeEnd('PERF:RPK:appDefineCustomCompFn(${p})')`),(0,_utils.isUXRender)(t)&&(n&&r.push(`console.record('### App Performance ### 启动页面自定义组件[PERF:RPK:appBootstrapCustomCompFn(${p})]开始：' + new Date().toJSON())\n      console.time('PERF:RPK:appBootstrapCustomCompFn(${p})')`),r.push(`$app_bootstrap$('@app-component/${p}',{ packagerVersion: QUICKAPP_TOOLKIT_VERSION })`),n&&r.push(`console.record('### App Performance ### 启动页面自定义组件[PERF:RPK:appBootstrapCustomCompFn(${p})]结束：' + new Date().toJSON())\n      console.timeEnd('PERF:RPK:appBootstrapCustomCompFn(${p})')`)),t===_utils.ENTRY_TYPE.COMP&&_compilationConfig.compileOptionsObject.enableLazyComponent&&(n&&r.push(`console.record('### App Performance ### 定义自定义组件封装[PERF:RPK:appDefineWrapCustomCompFn(${p})]开始：' + new Date().toJSON())\n      console.time('PERF:RPK:appDefineWrapCustomCompFn(${p})')`),r.unshift(`$app_define_wrap$('@app-component/${p}', function () {`),r.push("})"),n&&r.push(`\n      console.record('### App Performance ### 定义自定义组件封装[PERF:RPK:appDefineWrapCustomCompFn(${p})]结束：' + new Date().toJSON())\n      console.timeEnd('PERF:RPK:appDefineWrapCustomCompFn(${p})')`)),n&&r.push(`console.record('### App Performance ### 执行自定义组件模块[PERF:RPK:defineCustomCompModule(${p})]结束：' + new Date().toJSON())\n    console.timeEnd('PERF:RPK:defineCustomCompModule(${p})')`),r.join("\n")}function loader(e){const o=this.async(),p=this.resourcePath,{ext:t}=_path.default.parse(p);if(-1===[".mix",".ux"].indexOf(t))return void o(new Error(`未知文件格式：${t}`));const r=_loaderUtils.default.parseQuery(this.resourceQuery||"?"),n=r.uxType,s=r.name||(0,_utils.getNameByPath)(p);_validator.default.isReservedTag(s)&&this.emitWarning(new Error("脚本文件名不能使用保留字:"+s)),(0,_utils.print)({resourceQuery:this.resourceQuery,resourcePath:p,name:s});const a=(0,_compiler.parseFragmentsWithCache)(e,p);(0,_utils.print)(a),(0,_uxFragmentUtils.parseImportList)(this,a.import).then(()=>assemble(this,a,s,n)).then(e=>{o(null,e)}).catch(e=>{o(e,"")})}module.exports=loader;
//# sourceMappingURL=ux-loader.js.map
